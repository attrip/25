<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>25åˆ†é›†ä¸­ãƒŸãƒ‹ã‚¢ãƒ—ãƒª</title>
  <style>
    :root {
      --bg: #0f172a;
      --fg: #e2e8f0;
      --muted: #94a3b8;
      --accent: #22c55e;
      --warn: #fbbf24;
      --danger: #ef4444;
      --card: #111827;
      --panel: #0b1220;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, "Hiragino Kaku Gothic ProN", "Yu Gothic", Meiryo, sans-serif;
      background: radial-gradient(1200px 800px at 20% 10%, #0b1220, #0a0f1a, #090f1a), var(--bg);
      color: var(--fg);
      line-height: 1.5;
    }
    .container {
      max-width: 880px;
      padding: 24px;
      margin: 0 auto;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }
    h1 { font-size: 20px; margin: 0; color: #e5e7eb; }
    .screen { display: none; }
    .screen.active { display: block; }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 12px;
      padding: 16px;
    }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .spacer { height: 12px; }
    .timer {
      font-variant-numeric: tabular-nums;
      font-size: 56px;
      letter-spacing: 1px;
      text-align: center;
      margin: 8px 0 12px;
    }
    .muted { color: var(--muted); }
    button, .button-like {
      appearance: none;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(148, 163, 184, 0.08);
      color: var(--fg);
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 14px;
      cursor: pointer;
    }
    button.primary { border-color: #22c55e55; background: #22c55e22; }
    button.warn { border-color: #fbbf2455; background: #fbbf2422; }
    button.danger { border-color: #ef444455; background: #ef444422; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    textarea {
      width: 100%;
      min-height: 44vh;
      resize: vertical;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: #0b1220;
      color: var(--fg);
      font-size: 16px;
      line-height: 1.6;
    }
    ul.list { list-style: none; padding: 0; margin: 0; }
    ul.list li {
      padding: 10px 12px;
      border: 1px solid rgba(148,163,184,0.25);
      background: rgba(148,163,184,0.06);
      border-radius: 10px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .ghost { opacity: 0.7; }
    .focus-msg {
      text-align: center;
      font-weight: 600;
      letter-spacing: .02em;
      color: #f5f5f5;
    }
    .toast {
      position: fixed;
      left: 50%;
      bottom: 24px;
      transform: translateX(-50%);
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(34,197,94,0.15);
      color: #dcfce7;
      display: none;
      z-index: 1000;
    }
    .toast.show { display: block; }
  </style>
  <meta name="description" content="25åˆ†é›†ä¸­ + 5åˆ†ä¼‘æ†©ã‚’å›ã™ã€ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜å¯¾å¿œã®ã‚·ãƒ³ãƒ—ãƒ«ãªé›†ä¸­æ”¯æ´ã‚¢ãƒ—ãƒª" />
</head>
<body>
  <div class="container">
    <header>
      <h1>25åˆ†é›†ä¸­ãƒŸãƒ‹ã‚¢ãƒ—ãƒª</h1>
      <div class="row">
        <button id="btnHome" title="ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹">ãƒ›ãƒ¼ãƒ </button>
      </div>
    </header>

    <!-- ãƒ›ãƒ¼ãƒ ç”»é¢ -->
    <section id="screen-home" class="screen active">
      <div class="card">
        <div class="row">
          <button id="btnStart" class="primary">ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆ25åˆ†ï¼‰</button>
        </div>
        <div class="spacer"></div>
        <div class="muted">éå»ã®ä¿å­˜ãƒ†ã‚­ã‚¹ãƒˆ</div>
        <ul id="listSaved" class="list"></ul>
        <div id="emptySaved" class="muted ghost">ã¾ã ä¿å­˜ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
      </div>
    </section>

    <!-- ä½œæ¥­ç”»é¢ -->
    <section id="screen-work" class="screen">
      <div class="card">
        <div class="timer" id="timerWork">25:00</div>
        <div class="focus-msg" aria-live="polite">ä»Šã¯æ›¸ãã“ã¨ã ã‘</div>
        <div class="spacer"></div>
        <textarea id="editor" placeholder="ä»Šè€ƒãˆã¦ã„ã‚‹ã“ã¨ã‚’ã€ãã®ã¾ã¾æ›¸ãå§‹ã‚ã¾ã—ã‚‡ã†ã€‚è£…é£¾ã‚„æ•´å½¢ã¯å¾Œã§å¤§ä¸ˆå¤«ã§ã™ã€‚"></textarea>
        <div class="spacer"></div>
        <div class="row">
          <button id="btnSave" class="primary">ä¿å­˜</button>
          <button id="btnPause" class="warn">ä¸€æ™‚åœæ­¢</button>
          <button id="btnReset" class="danger">ãƒªã‚»ãƒƒãƒˆ</button>
          <button id="btnMic" title="éŸ³å£°å…¥åŠ›">ğŸ¤ éŸ³å£°å…¥åŠ›é–‹å§‹</button>
        </div>
        <div class="spacer"></div>
        <div id="micStatus" class="muted" style="display:none">éŸ³å£°å…¥åŠ›ä¸­â€¦</div>
        <div id="micInterim" class="muted" style="display:none"></div>
      </div>
    </section>

    <!-- ä¼‘æ†©ç”»é¢ -->
    <section id="screen-break" class="screen">
      <div class="card">
        <div class="timer" id="timerBreak">05:00</div>
        <div class="focus-msg muted" aria-live="polite">è‚©ã®åŠ›ã‚’æŠœã„ã¦ãƒªãƒ©ãƒƒã‚¯ã‚¹</div>
        <div class="spacer"></div>
        <div class="row">
          <button id="btnSkipBreak" class="warn">ä¼‘æ†©ã‚’ã‚¹ã‚­ãƒƒãƒ—</button>
          <button id="btnBackHome">ãƒ›ãƒ¼ãƒ ã¸</button>
        </div>
      </div>
    </section>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">1ã‚¿ãƒ¼ãƒ å®Œäº†ï¼ãŠç–²ã‚Œã•ã¾ã§ã—ãŸã€‚</div>

  <script>
    // è¨­å®š
    const WORK_MIN = 25;
    const BREAK_MIN = 5;
    // é–‹ç™ºç¢ºèªã‚’æ—©ã‚ã«: URLã« ?dev=1 ã§ 25ç§’/5ç§’ ã«çŸ­ç¸®
    const DEV = new URLSearchParams(location.search).get('dev') === '1';
    const WORK_SEC = DEV ? 25 : WORK_MIN * 60;
    const BREAK_SEC = DEV ? 5 : BREAK_MIN * 60;

    // çŠ¶æ…‹
    let state = 'home'; // 'home' | 'work' | 'break'
    let timerId = null;
    let remaining = 0;
    let paused = false;
    let currentEntryId = null; // ç·¨é›†ä¸­ã®IDï¼ˆæ–°è¦ãªã‚‰ nullï¼‰

    // è¦ç´ å–å¾—
    const $ = (sel) => document.querySelector(sel);
    const scrHome = $('#screen-home');
    const scrWork = $('#screen-work');
    const scrBreak = $('#screen-break');
    const timerWork = $('#timerWork');
    const timerBreak = $('#timerBreak');
    const editor = $('#editor');
    const listSaved = $('#listSaved');
    const emptySaved = $('#emptySaved');
    const toast = $('#toast');
    const micStatus = $('#micStatus');
    const micInterim = $('#micInterim');

    // ç”»é¢åˆ‡æ›¿
    function showScreen(name) {
      state = name;
      for (const el of document.querySelectorAll('.screen')) el.classList.remove('active');
      if (name === 'home') scrHome.classList.add('active');
      if (name === 'work') scrWork.classList.add('active');
      if (name === 'break') scrBreak.classList.add('active');
      if (name !== 'work') stopMic(); // ç”»é¢é·ç§»æ™‚ã«éŸ³å£°å…¥åŠ›ã‚’åœæ­¢
    }

    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    function fmt(sec) {
      const m = Math.floor(sec / 60).toString().padStart(2, '0');
      const s = Math.floor(sec % 60).toString().padStart(2, '0');
      return `${m}:${s}`;
    }
    function toastShow(msg, ms = 2500) {
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), ms);
    }

    // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
    const LS_KEY = 'focus_entries_v1';
    function loadAll() {
      try { return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); }
      catch { return []; }
    }
    function saveAll(arr) {
      localStorage.setItem(LS_KEY, JSON.stringify(arr));
    }
    function upsertEntry(entry) {
      const all = loadAll();
      if (!entry.id) entry.id = `e_${Date.now()}`;
      const i = all.findIndex(x => x.id === entry.id);
      if (i >= 0) all[i] = entry; else all.unshift(entry);
      saveAll(all);
      return entry.id;
    }
    function deleteEntry(id) {
      const all = loadAll().filter(x => x.id !== id);
      saveAll(all);
    }
    function refreshList() {
      const all = loadAll();
      listSaved.innerHTML = '';
      if (all.length === 0) {
        emptySaved.style.display = 'block';
        return;
      }
      emptySaved.style.display = 'none';
      for (const e of all) {
        const li = document.createElement('li');
        const left = document.createElement('div');
        const right = document.createElement('div');
        const dt = new Date(e.ts || Date.now());
        left.innerHTML = `<div><strong>${escapeHtml(e.title || '(ç„¡é¡Œ)')}</strong></div><div class="muted">${dt.toLocaleString()}</div>`;
        const openBtn = document.createElement('button');
        openBtn.textContent = 'é–‹ã';
        openBtn.title = 'ã‚¨ãƒ‡ã‚£ã‚¿ã«èª­ã¿è¾¼ã¿';
        openBtn.onclick = () => {
          editor.value = e.text || '';
          currentEntryId = e.id;
          startWork(false); // èª­ã¿è¾¼ã¿ã®ã¿ï¼ˆã‚«ã‚¦ãƒ³ãƒˆã¯é–‹å§‹ã—ãªã„ï¼‰
        };
        const delBtn = document.createElement('button');
        delBtn.textContent = 'å‰Šé™¤';
        delBtn.className = 'danger';
        delBtn.onclick = () => { if (confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { deleteEntry(e.id); refreshList(); } };
        right.className = 'row';
        right.appendChild(openBtn);
        right.appendChild(delBtn);
        li.appendChild(left);
        li.appendChild(right);
        listSaved.appendChild(li);
      }
    }
    function escapeHtml(s) {
      return (s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    }

    // ã‚¿ã‚¤ãƒãƒ¼
    function clearTimer() { if (timerId) { clearInterval(timerId); timerId = null; } }

    function startWork(startCountdown = true) {
      showScreen('work');
      clearTimer();
      paused = false;
      remaining = WORK_SEC;
      timerWork.textContent = fmt(remaining);
      if (startCountdown) runCountdown('work');
    }

    function startBreak() {
      showScreen('break');
      clearTimer();
      paused = false;
      remaining = BREAK_SEC;
      timerBreak.textContent = fmt(remaining);
      runCountdown('break');
    }

    function runCountdown(kind) {
      const tick = () => {
        if (paused) return;
        remaining -= 1;
        if (kind === 'work') timerWork.textContent = fmt(Math.max(0, remaining));
        if (kind === 'break') timerBreak.textContent = fmt(Math.max(0, remaining));
        if (remaining <= 0) {
          clearTimer();
          if (kind === 'work') {
            startBreak();
          } else {
            toastShow('1ã‚¿ãƒ¼ãƒ å®Œäº†ï¼ãŠç–²ã‚Œã•ã¾ã§ã—ãŸã€‚');
            showScreen('home');
          }
        }
      };
      // 1ç§’æ¯
      timerId = setInterval(tick, 1000);
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆ
    $('#btnHome').onclick = () => { clearTimer(); showScreen('home'); refreshList(); };
    $('#btnBackHome').onclick = () => { clearTimer(); showScreen('home'); refreshList(); };
    $('#btnStart').onclick = () => { currentEntryId = null; editor.value = ''; startWork(true); };
    $('#btnPause').onclick = () => { paused = !paused; $('#btnPause').textContent = paused ? 'å†é–‹' : 'ä¸€æ™‚åœæ­¢'; };
    $('#btnReset').onclick = () => { if (state === 'work') startWork(false); if (state === 'break') startBreak(); };
    $('#btnSkipBreak').onclick = () => { clearTimer(); toastShow('ä¼‘æ†©ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ'); showScreen('home'); };

    $('#btnSave').onclick = () => {
      const text = editor.value || '';
      const firstLine = (text.split(/\n/, 1)[0] || '').trim();
      const title = firstLine || 'ï¼ˆç„¡é¡Œï¼‰';
      const entry = { id: currentEntryId, title, text, ts: Date.now() };
      currentEntryId = upsertEntry(entry);
      toastShow('ä¿å­˜ã—ã¾ã—ãŸ');
      refreshList();
    };

    // éŸ³å£°å…¥åŠ›
    const recSupported = 'SpeechRecognition' in window || 'webkitSpeechRecognition' in window;
    let rec = null;
    let recListening = false; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒONã«ã—ã¦ã„ã‚‹ã‹
    let micPermissionChecked = false;

    function ensureRecognizer() {
      if (!recSupported) return null;
      if (rec) return rec;
      const Ctor = window.SpeechRecognition || window.webkitSpeechRecognition;
      rec = new Ctor();
      rec.lang = 'ja-JP';
      rec.continuous = true;
      rec.interimResults = true;
      rec.maxAlternatives = 1;
      rec.onstart = () => {
        micStatus.style.display = 'block';
        micStatus.textContent = 'éŸ³å£°å…¥åŠ›ä¸­â€¦';
        updateMicUI();
      };
      rec.onresult = (e) => {
        let interim = '';
        for (let i = e.resultIndex; i < e.results.length; i++) {
          const res = e.results[i];
          const txt = res[0]?.transcript || '';
          if (res.isFinal) appendToEditor(txt.trim());
          else interim += txt;
        }
        // æš«å®šçµæœã®è¦–è¦šåŒ–
        interim = (interim || '').trim();
        if (interim) {
          micInterim.style.display = 'block';
          micInterim.textContent = 'èãå–ã‚Šä¸­: ' + interim;
        } else {
          micInterim.style.display = 'none';
        }
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡Œ
        if (recListening) {
          micStatus.style.display = 'block';
          micStatus.textContent = interim ? 'éŸ³å£°å…¥åŠ›ä¸­â€¦' : 'éŸ³å£°å…¥åŠ›ä¸­â€¦';
        }
      };
      rec.onerror = (e) => {
        const err = e?.error || 'unknown';
        if (err === 'not-allowed' || err === 'service-not-allowed') {
          recListening = false;
        }
        // 'no-speech' ã¯ç„¡éŸ³ã€'network' ã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æœªåˆ°é”
        toastShow('éŸ³å£°å…¥åŠ›ã‚¨ãƒ©ãƒ¼: ' + err);
      };
      rec.onend = () => {
        // è¨±å¯ãŒé€šã£ã¦ãŠã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒONã®ã¾ã¾ãªã‚‰è‡ªå‹•å†é–‹
        if (recListening && micPermissionChecked) {
          try { rec.start(); return; } catch {}
        }
        micStatus.style.display = 'none';
        micInterim.style.display = 'none';
        updateMicUI();
      };
      return rec;
    }

    function appendToEditor(text) {
      if (!text) return;
      // æœ«å°¾ã«è¿½è¨˜ï¼ˆå¿…è¦ãªã‚‰ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã¸ã®æŒ¿å…¥ã«æ‹¡å¼µå¯ï¼‰
      const needsSpace = editor.value && !editor.value.endsWith('\n') ? ' ' : '';
      editor.value = editor.value + needsSpace + text;
      editor.selectionStart = editor.selectionEnd = editor.value.length;
    }

    function updateMicUI() {
      const btn = $('#btnMic');
      if (!recSupported) {
        btn.disabled = true;
        btn.title = 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“';
        return;
      }
      btn.textContent = recListening ? 'ğŸ¤ éŸ³å£°å…¥åŠ›åœæ­¢' : 'ğŸ¤ éŸ³å£°å…¥åŠ›é–‹å§‹';
    }
    async function requestMicPermission() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) return;
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        // ç›´ã¡ã«åœæ­¢ã—ã¦éŸ³å£°èªè­˜ã«åˆ‡æ›¿
        stream.getTracks().forEach(t => t.stop());
        micPermissionChecked = true;
      } catch (e) {
        throw e;
      }
    }

    async function startMic() {
      if (!recSupported) return alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
      if (!rec) ensureRecognizer();
      try {
        // å…ˆã«ãƒã‚¤ã‚¯è¨±å¯ã‚’è¦æ±‚ï¼ˆè¨±å¯å¾Œã« SpeechRecognition ã‚’é–‹å§‹ï¼‰
        if (!micPermissionChecked && navigator.mediaDevices?.getUserMedia) {
          await requestMicPermission();
        }
        recListening = true;
        rec.start();
        editor.focus();
      } catch (e) {
        recListening = false;
        toastShow('éŸ³å£°å…¥åŠ›ã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã®ãƒã‚¤ã‚¯è¨±å¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      }
      updateMicUI();
    }
    function stopMic() {
      if (!rec) { recListening = false; updateMicUI(); return; }
      try { recListening = false; rec.stop(); } catch {}
      micStatus.style.display = 'none';
      micInterim.style.display = 'none';
      updateMicUI();
    }
    $('#btnMic').onclick = async () => {
      if (!recSupported) return alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
      if (!recListening) await startMic();
      else stopMic();
    };

    updateMicUI();

    // åˆæœŸåŒ–
    refreshList();
  </script>
</body>
</html>
